<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>실시간 출입 현황</title>

    <!-- SockJS / STOMP (실제 위치에 맞게 경로 수정 필요) -->
    <script th:src="@{/common/js/sockjs.min.js}"></script>
    <script th:src="@{/common/js/stomp.min.js}"></script>
</head>
<body>
    <h2>실시간 출입 현황</h2>

    <p>현재 설정된 Device ID: <span id="currentDeviceId"></span></p>

    <table border="1" style="border-collapse: collapse;">
        <thead>
        <tr>
            <th>시간</th>
            <th>이름</th>
            <th>구분 (IN/OUT)</th>
            <th>장비 ID</th>
        </tr>
        </thead>
        <tbody id="eventTableBody">
        <!-- WebSocket 수신 데이터가 이 안에 추가된다 -->
        </tbody>
    </table>

    <script>
        let stompClient = null;
        const deviceId = localStorage.getItem("DEVICE_ID");
        const currentDeviceIdSpan = document.getElementById("currentDeviceId");
        currentDeviceIdSpan.textContent = deviceId ? deviceId : "(미설정)";

        if (!deviceId) {
            alert("Device ID가 설정되지 않았습니다. 설정 화면으로 이동합니다.");
            window.location.href = "/setup/admin-password";
        } else {
            connectWebSocket();
        }

        function connectWebSocket() {
            // WebSocketConfig 에서 설정한 엔드포인트(/ws)와 연결
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // /topic/events 구독
                stompClient.subscribe('/topic/event', function (message) {
                    const event = JSON.parse(message.body);

                    // deviceId가 현재 Device ID와 일치하는 데이터만 테이블에 표시
                    if (event.deviceId === deviceId) {
                        addRow(event);
                    }
                });
            });
        }

        function addRow(event) {
            const tbody = document.getElementById("eventTableBody");
            const tr = document.createElement("tr");

            const tdTime = document.createElement("td");
            tdTime.textContent = event.eventTime || "-";

            const tdUser = document.createElement("td");
            tdUser.textContent = event.userName || "-";

            const tdDir = document.createElement("td");
            tdDir.textContent = event.accessType || "-";

            const tdDevice = document.createElement("td");
            tdDevice.textContent = event.deviceId || "-";

            tr.appendChild(tdTime);
            tr.appendChild(tdUser);
            tr.appendChild(tdDir);
            tr.appendChild(tdDevice);

            // 최근 기록이 위로 쌓이게 하려면 아래 대신 insertBefore 사용
            tbody.appendChild(tr);
        }
    </script>
</body>
</html>
