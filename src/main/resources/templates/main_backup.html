<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>실시간 출입 현황</title>

    <!-- SockJS / STOMP -->
    <script th:src="@{/common/js/sockjs.min.js}"></script>
    <script th:src="@{/common/js/stomp.min.js}"></script>

    <style>
        body { font-family: sans-serif; }
        h2 { margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
        #toolbar { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #resetBtn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 6px;
        }
        #resetBtn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
<div id="toolbar">
    <h2>실시간 출입 현황</h2>
    <button id="resetBtn">관리자 설정 초기화</button>
</div>

    <p>현재 설정된 Device ID: <strong id="currentDeviceId"></strong></p>

    <table>
        <thead>
        <tr>
            <th>시간</th>
            <th>이름</th>
            <th>구분 (IN/OUT)</th>
            <th>장비 ID</th>
        </tr>
        </thead>
        <tbody id="eventTableBody">
        <!-- 데이터 표시 영역 -->
        </tbody>
    </table>

    <script>
        let stompClient = null;
        const deviceId = localStorage.getItem("deviceId");
        const currentDeviceIdSpan = document.getElementById("currentDeviceId");
        const resetBtn = document.getElementById("resetBtn");

        currentDeviceIdSpan.textContent = deviceId ? deviceId : "(미설정)";

        if (!deviceId) {
            alert("Device ID가 설정되지 않았습니다. 설정 화면으로 이동합니다.");
            window.location.href = "/setup/admin-password";
        } else {
            connectWebSocket();
        }

        function connectWebSocket() {
            // WebSocketConfig 에서 설정한 엔드포인트(/ws)와 연결
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // /sub/events 구독
                stompClient.subscribe('/sub/event', function (message) {
                    const event = JSON.parse(message.body);

                    // deviceId가 현재 Device ID와 일치하는 데이터만 테이블에 표시
                    if (event.deviceId === deviceId) {
                        addRow(event);
                    }
                });
            });
        }

        function addRow(event) {
            const tbody = document.getElementById("eventTableBody");
            const tr = document.createElement("tr");

            const tdTime = document.createElement("td");
            tdTime.textContent = event.eventTime || "-";

            const tdUser = document.createElement("td");
            tdUser.textContent = event.userName || "-";

            const tdType = document.createElement("td");
            tdType.textContent = event.accessType || "-";
            tdType.style.fontWeight = "bold";
            tdType.style.color = event.direction === "IN" ? "green" : "red";

            const tdDevice = document.createElement("td");
            tdDevice.textContent = event.deviceId || "-";

            tr.appendChild(tdTime);
            tr.appendChild(tdUser);
            tr.appendChild(tdType);
            tr.appendChild(tdDevice);

            // 최근 데이터가 위로 올라오게 (최신순 정렬)
            tbody.insertBefore(tr, tbody.firstChild);
        }

        // 관리자 설정 초기화 버튼 클릭 시
        resetBtn.addEventListener("click", function () {
            console.log("리셋 버튼 클릭 이벤트 발생 !! ");
            if (confirm("Device ID를 초기화하고 관리자 설정 화면으로 이동하시겠습니까?")) {
                localStorage.removeItem("deviceId");
                alert("Device ID가 초기화되었습니다.");
                window.location.href = "/setup/admin-password";
            }
        });
    </script>
</body>
</html>
